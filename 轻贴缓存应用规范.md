# 轻贴缓存应用规范

## 总览
- 缓存介质以 `Redis` 为主，读写统一使用 `StringRedisTemplate` 或封装的 `RedisCache`/`RedisCache1`，序列化采用字符串 JSON 与 FastJson 序列化并存。
- 主要场景覆盖：列表首屏与分页、对象详情、计数增量、去重与幂等、离线与实时消息、验证码/登录态、关注关系与派生计数、附件索引与批量读取、指标采集与暂存。
- 设计上具备防穿透、限时 TTL、异步落库、分布式锁、Bloom 过滤等机制；二级缓存（Caffeine+Redis）已具备代码与配置但当前处于停用（注释）。

## 基础设施
- RedisTemplate 初始化与序列化：`src/main/java/com/tmd/config/RedisConfig.java:12`，Key 使用 `StringRedisSerializer`，Value/HashValue 使用 `FastJsonRedisSerializer`；同时注册 `RedissonClient` 用于分布式锁与 Bloom 过滤。
- 通用封装类：
  - `RedisCache` 封装对象/集合/Map 的读写与 TTL、删除，常用于用户与附件等场景（如 `UserServiceimpl`、`AttachmentServiceImpl`）。`src/main/java/com/tmd/config/RedisCache.java:20`。
  - `RedisCache1` 封装常用 KV/Hash/Set 操作，主要被二级缓存管理器引用；当前组合缓存实现处于注释状态。`src/main/java/com/tmd/config/RedisCache1.java:13`。
- 二级缓存（停用）：`RedisCaffeineCacheManager`、`RedisCaffeineCache`、`CacheMessageListener` 与 `CacheRedisCaffeineAutoConfiguration` 实现了本地 Caffeine + 远端 Redis 的组合缓存与跨节点失效通知，当前整体用 `/* ... */` 注释关闭，保留配置模型 `L2CacheConfig`/`L2CacheProperties`。参考：
  - 管理器：`src/main/java/com/tmd/spring/RedisCaffeineCacheManager.java:1`
  - 适配器：`src/main/java/com/tmd/spring/RedisCaffeineCache.java:1`
  - 监听器：`src/main/java/com/tmd/sync/CacheMessageListener.java:1`
  - 自动配置：`src/main/java/com/tmd/config/CacheRedisCaffeineAutoConfiguration.java:1`
  - 配置模型：`src/main/java/com/tmd/config/L2CacheConfig.java:18`，`src/main/java/com/tmd/config/L2CacheProperties.java:10`

## 典型场景与用法
- 帖子列表与统计（首屏与分页、热度维度）
  - 列表与总数缓存，按 `type/status/sort/page/size` 维度分键，TTL：列表 200s/总数 300s；未命中时加锁异步回填。`src/main/java/com/tmd/service/impl/PostsServiceImpl.java:75`、`src/main/java/com/tmd/service/impl/PostsServiceImpl.java:121`。
  - ZSet 分层缓存：`latest` 用创建时间分数，`hot` 用浏览量分数，便于快速排序与首屏；批量恢复。`src/main/java/com/tmd/service/impl/PostsServiceImpl.java:228`。
  - PV/UV 计数：`opsForValue.increment` + HyperLogLog 去重；窗口去重 Key `post:view:seen:{postId}:{uid}` TTL 5 分钟；达到阈值（50）批量刷盘并回写 ES。`src/main/java/com/tmd/service/impl/PostsServiceImpl.java:318`、`src/main/java/com/tmd/service/impl/PostsServiceImpl.java:348`。
  - 点赞/收藏集合：每帖 `Set` 维护用户集合，同时维护用户侧集合与增量 Flush Key，触发阈值批量刷库与 ES 更新。`src/main/java/com/tmd/service/impl/PostsServiceImpl.java:449`、`src/main/java/com/tmd/service/impl/PostsServiceImpl.java:650`。
  - 防击穿与并发：Redisson 分布式锁，轻量异步回填、体验优先的返回策略。
- 话题与话题列表
  - 首屏话题集合：`topics:all` 用 ZSet 按时间排序，未命中加锁异步恢复；创建话题时同步写入 ZSet。`src/main/java/com/tmd/service/impl/TopicServiceImpl.java:75`、`src/main/java/com/tmd/service/impl/TopicServiceImpl.java:232`。
  - 话题详情按 ID 缓存：命中直接返回，否则查 DB 并写入缓存；未找到时缓存空字符串 60s 防穿透。TTL 300s。`src/main/java/com/tmd/service/impl/TopicServiceImpl.java:131`。
  - 话题帖子列表：按 `topicId/status/sort/page/size` 维度缓存，未命中加锁后回填。`src/main/java/com/tmd/service/impl/TopicServiceImpl.java:339`。
- 邮件与评论/来信
  - 邮件详情缓存：`mail:{id}`，TTL 5 分钟，空值缓存防穿透。`src/main/java/com/tmd/service/impl/MailServiceImpl.java:72`。
  - 全部邮件首屏：`mails:all` 用 ZSet 存 `id` 与当前时间分数，锁控异步恢复。`src/main/java/com/tmd/service/impl/MailServiceImpl.java:131`。
  - 收件箱推送：`mail:push:{uid}` ZSet；评论列表：`mail:comment:{uid}` List，分页读取与锁控批量恢复。`src/main/java/com/tmd/service/impl/MailServiceImpl.java:371`、`src/main/java/com/tmd/service/impl/MailServiceImpl.java:452`。
  - 智能洞察缓存与幂等：`mail:agent:insight:{mailId}` TTL 2 分钟；用 `setIfAbsent` 调度生成锁 Key，生成完成后删除。`src/main/java/com/tmd/service/impl/MailServiceImpl.java:545`、`src/main/java/com/tmd/service/impl/MailServiceImpl.java:584`。
- 私聊与离线消息
  - 会话 ZSet：`chat:conv:{minUid}:{maxUid}`，按时间分数存 JSON；消息 KV：`chat:msg:{id}` 便于状态更新；离线 ZSet：`chat:offline:{uid}`；ACK KV：`chat:ack:{msgId}` TTL 5 分钟。`src/main/java/com/tmd/service/impl/PrivateChatServiceImpl.java:45`、`src/main/java/com/tmd/service/impl/PrivateChatServiceImpl.java:70`、`src/main/java/com/tmd/service/impl/PrivateChatServiceImpl.java:136`、`src/main/java/com/tmd/service/impl/PrivateChatServiceImpl.java:278`。
  - 定期窗口清理与 TTL：会话 ZSet 设 7 天 TTL 并滚动删旧分数。`src/main/java/com/tmd/service/impl/PrivateChatServiceImpl.java:76`。
- 登录态与验证码
  - 登录态：`login:{token}` 存 `LoginUser`，在过滤器中刷新 TTL 至 30 分钟。`src/main/java/com/tmd/service/impl/UserServiceimpl.java:74`、`src/main/java/com/tmd/filter/JwtAuthenticationTokenFilter.java:64`。
  - 公钥登录态：`loginPublic:{token}` 特殊授权路径。`src/main/java/com/tmd/filter/JwtAuthenticationTokenFilter.java:39`。
  - 验证码：`captcha:{uuid}` TTL 2 分钟，验证后删除。`src/main/java/com/tmd/controller/CaptchaController.java:30`、`src/main/java/com/tmd/controller/UserController.java:74`。
- 关注关系与派生计数
  - 关注/粉丝集合：`follow:{uid}`/`followers:{uid}` 用 Set，过期 7 天；派生计数 Key 以 `follow_count:`、`follower_count:` 维护增减与 TTL。`src/main/java/com/tmd/service/impl/FollowServiceImpl.java:46`、`src/main/java/com/tmd/service/impl/FollowServiceImpl.java:241`、`src/main/java/com/tmd/service/impl/FollowServiceImpl.java:268`。
- 附件索引与批读取
  - 多维 Key：按 `id`、`fileId`、`business:{type}:{id}`、`uploader:{id}` 读写；对象 TTL 7 天、列表 TTL 7 天；批量 miss 一次性查库并分组回填；写入/删除时同步失效相关列表与索引 Key。`src/main/java/com/tmd/service/impl/AttachmentServiceImpl.java:45`、`src/main/java/com/tmd/service/impl/AttachmentServiceImpl.java:191`、`src/main/java/com/tmd/service/impl/AttachmentServiceImpl.java:344`、`src/main/java/com/tmd/service/impl/AttachmentServiceImpl.java:575`。
- 用户资料缓存与书签
  - 用户基础资料：`user:profile:{uid}` TTL 10 分钟，更新时主动删除该 Key。`src/main/java/com/tmd/service/impl/UserServiceimpl.java:85`、`src/main/java/com/tmd/service/impl/UserServiceimpl.java:125`。
  - 每日书签：`bookmark:{uid}` 保存图片 URL，不落库；每日定时清理通过 `SCAN` 批量删除，并同步清理 OSS 对象。`src/main/java/com/tmd/consumer/MessageConsumer.java:228`、`src/main/java/com/tmd/task/Task.java:29`。
- 指标采集暂存
  - 计数器：`metrics:counters:{name}` Hash，`inc` 聚合；定时从 List `metrics:events` 批量落库。`src/main/java/com/tmd/metrics/impl/MetricsServiceImpl.java:30`、`src/main/java/com/tmd/metrics/impl/MetricsServiceImpl.java:118`。
- 其他
  - 用户磁贴：`Stick:{uid}` 整体列表缓存，无 TTL，变更时删除以触发重建。`src/main/java/com/tmd/controller/StickController.java:47`、`src/main/java/com/tmd/controller/StickController.java:118`。
  - 人物磁贴：`PStick:{uid}` 读取时做 JSON 结构健壮性校验。`src/main/java/com/tmd/controller/PStickController.java:43`。
  - 分布式 ID：`icr:{biz}:{yyyy:MM:dd}` Redis 自增结合时间戳位运算生成 64 位有序 ID（非典型缓存，但共享了 Redis 基础设施）。`src/main/java/com/tmd/tools/RedisIdWorker.java:17`。

## 合理性评估与对照
- Key 设计
  - 使用明确业务维度与层级（如 `post:list:type:status:sort:page:size`、`topic:id:{id}`）总体合理，建议统一分隔符与层级规范，避免重复与歧义，限制 Key 长度。
- TTL 策略
  - 列表/详情在帖子、话题、邮件场景设置了短 TTL（200–300s/5min/10min/7d 等），读多写少场景合理；用户磁贴无 TTL，建议增加短 TTL（如 5–15min）以降低长期脏读风险。
  - 空值缓存用于防穿透已在话题与邮件落地，建议扩展到其他高穿透路径（如附件/个人磁贴 miss 时短 TTL 空列表）。
- 并发与一致性
  - Redisson 锁、异步回填与增量阈值刷盘组合良好；点赞/收藏/浏览以增量 Key 控制刷库频率避免热帖抖动，读路径计算“DB 值 + 缓存增量”提升体验，设计合理。
  - 附件写入采取“先缓存、异步落库”，需要关注双写失败恢复与补偿（当前已使用事务模板与异常处理，建议加入重试与告警）。
- 反压与防御
  - 帖子使用 Bloom 过滤器减少无效写，话题/邮件用空值短 TTL 防穿透；建议统一在访问量高的详情路径接入 Bloom（用户/附件）。
- 组合缓存（L1+L2）
  - 代码与配置完整但已停用，若面向多实例部署且热点读多，可考虑恢复 Caffeine 本地缓存与 Redis 失效广播，注意：跨节点一致性与本地过期策略需要审慎配置。
- 序列化与模板并存
 - 业务大量使用 `StringRedisTemplate` 存储 JSON 字符串，同时 `RedisTemplate` 配置了 FastJson；建议选型统一（推荐 JSON 字符串 + 显式模型转换），避免类型反序列化耦合与升级风险。

## 数据一致性策略
- 写后一致性
  - 用户资料更新后删除缓存 Key，下一次读取强制命中数据库，避免脏读：`src/main/java/com/tmd/service/impl/UserServiceimpl.java:125`。
  - 附件写入采取“先写缓存、异步事务落库”，并在失败时保留日志；关联列表与索引 Key在写入/删除时同步失效，保证下次读取重建：`src/main/java/com/tmd/service/impl/AttachmentServiceImpl.java:78`、`src/main/java/com/tmd/service/impl/AttachmentServiceImpl.java:111`、`src/main/java/com/tmd/service/impl/AttachmentServiceImpl.java:454`、`src/main/java/com/tmd/service/impl/AttachmentServiceImpl.java:575`。
  - 帖子交互（浏览/点赞/收藏）采用“实时写集合/增量计数 + 阈值批量刷库”的最终一致性模型：交互当下通过 `Set` 与 `flushKey` 立即反映到读取体验，达到阈值后加锁批量写回 MySQL，并通过 ES 脚本保持搜索索引一致：`src/main/java/com/tmd/service/impl/PostsServiceImpl.java:318`、`src/main/java/com/tmd/service/impl/PostsServiceImpl.java:470`、`src/main/java/com/tmd/service/impl/PostsServiceImpl.java:683`。
- 读后一致性
  - 列表与详情未命中时采用分布式锁控制异步回填，读路径直接返回空或提示，避免阻塞；回填完成后下一次读取命中缓存：`src/main/java/com/tmd/service/impl/PostsServiceImpl.java:155`、`src/main/java/com/tmd/service/impl/TopicServiceImpl.java:364`、`src/main/java/com/tmd/service/impl/MailServiceImpl.java:166`。
  - 空值短 TTL 防穿透，确保不存在的数据不会持续打到数据库：`src/main/java/com/tmd/service/impl/TopicServiceImpl.java:145`、`src/main/java/com/tmd/service/impl/MailServiceImpl.java:112`。
  - Bloom 过滤器在帖子场景减少无效写，降低一致性恢复压力：`src/main/java/com/tmd/service/impl/PostsServiceImpl.java:292`。
- 失效与重建
  - 用户磁贴/人物磁贴在更新/删除后主动删除用户级缓存 Key，下一次读取按需重建：`src/main/java/com/tmd/controller/StickController.java:118`、`src/main/java/com/tmd/controller/StickController.java:146`。
  - 附件在写入/删除时同步清理业务列表与上传者列表缓存，防止索引与对象不一致：`src/main/java/com/tmd/service/impl/AttachmentServiceImpl.java:456`、`src/main/java/com/tmd/service/impl/AttachmentServiceImpl.java:609`。
- 幂等与去重
  - 私聊 ACK 通过 `chat:ack:{msgId}`（TTL 5 分钟）判断送达，未 ACK 则回退状态并入离线集合，避免重复投递导致状态紊乱：`src/main/java/com/tmd/service/impl/PrivateChatServiceImpl.java:97`、`src/main/java/com/tmd/service/impl/PrivateChatServiceImpl.java:217`、`src/main/java/com/tmd/service/impl/PrivateChatServiceImpl.java:279`。
  - 邮件智能洞察生成通过 `setIfAbsent` 的“计划锁”避免重复生成与并发覆盖，生成完成后删除计划 Key：`src/main/java/com/tmd/service/impl/MailServiceImpl.java:545`、`src/main/java/com/tmd/service/impl/MailServiceImpl.java:584`。
- 事务与锁
  - 使用 `TransactionTemplate` 包裹数据库写操作，结合异常处理提升写一致性与可回滚性：`src/main/java/com/tmd/service/impl/AttachmentServiceImpl.java:86`、`src/main/java/com/tmd/service/impl/AttachmentServiceImpl.java:159`、`src/main/java/com/tmd/service/impl/AttachmentServiceImpl.java:403`。
  - 分布式锁控制高并发下的缓存重建与批量刷库互斥窗口，减少并发覆盖与抖动：`src/main/java/com/tmd/service/impl/PostsServiceImpl.java:157`、`src/main/java/com/tmd/service/impl/MailServiceImpl.java:143`、`src/main/java/com/tmd/service/impl/TopicServiceImpl.java:365`。
- 多系统一致性
  - MySQL 与 ES 的计数保持通过内联脚本更新实现，确保搜索结果与数据库一致；同时以 `flushKey` 回写自减保证增量一致闭环：`src/main/java/com/tmd/service/impl/PostsServiceImpl.java:382`、`src/main/java/com/tmd/service/impl/PostsServiceImpl.java:520`、`src/main/java/com/tmd/service/impl/PostsServiceImpl.java:701`。
- 多副本一致性（当前停用）
  - 组合缓存（Caffeine+Redis）实现了本地副本与远端副本的一致性清理广播，当前处于注释停用；如启用需保证失效广播与本地过期策略一致协调：`src/main/java/com/tmd/spring/RedisCaffeineCache.java:252`、`src/main/java/com/tmd/sync/CacheMessageListener.java:20`。
- 定时与存储一致
  - 每日书签通过定时任务清理 Redis Key 与对应 OSS 对象，避免缓存与对象存储不一致与资源泄漏：`src/main/java/com/tmd/task/Task.java:29`。

## 一致性方案对照与结论
- Cache-Aside（旁路缓存）
  - 读路径：广泛采用“先读缓存，未命中查库并回写”的模式，覆盖话题详情、邮件详情、列表首屏等：`src/main/java/com/tmd/service/impl/TopicServiceImpl.java:131`、`src/main/java/com/tmd/service/impl/MailServiceImpl.java:72`、`src/main/java/com/tmd/service/impl/PostsServiceImpl.java:121`。
  - 写路径：关键对象更新后以“删缓存”保证下次强制命中数据库，如用户资料更新：`src/main/java/com/tmd/service/impl/UserServiceimpl.java:125`；用户磁贴在新增/修改/删除后删除用户级缓存：`src/main/java/com/tmd/controller/StickController.java:118`、`src/main/java/com/tmd/controller/StickController.java:146`。
  - 偏差点：附件写入采取“先写缓存、再异步落库”，并非纯粹旁路写；人物磁贴更新未做缓存删除：`src/main/java/com/tmd/controller/PStickController.java:70`。结论：总体符合旁路缓存思想，但个别写路径未严格“先更库后删缓存”。
- 延时双删
  - 当前实现为“单次删除”，未见延时二次删除的调度与实现（无延时任务、无消息驱动二次删）。结论：未落地延时双删，可在高并发更新场景引入延时二次删（如 1–3s）增强并发一致性。
- Write-Back（写回）
  - 典型落地：帖子交互（浏览/点赞/收藏）采用集合/增量计数即时反映，达到阈值后批量刷库并脚本更新 ES：`src/main/java/com/tmd/service/impl/PostsServiceImpl.java:318`、`src/main/java/com/tmd/service/impl/PostsServiceImpl.java:470`、`src/main/java/com/tmd/service/impl/PostsServiceImpl.java:683`。
  - 附件场景：对象写入先缓存，随后事务化异步写库，并且在删除时先清缓存后异步删库：`src/main/java/com/tmd/service/impl/AttachmentServiceImpl.java:86`、`src/main/java/com/tmd/service/impl/AttachmentServiceImpl.java:403`、`src/main/java/com/tmd/service/impl/AttachmentServiceImpl.java:575`。此为写回思想的变体，优先读体验。
  - 风险与兜底：未见“缓存删除失败重试/死信队列”机制；多数 Key 设置了 TTL 作兜底，但如 `Stick:{uid}`、部分指标键未设 TTL。结论：写回方案已应用于高写路径，但需补充删除重试与统一 TTL 兜底。

## 改进建议（可执行）
- 人物磁贴更新后增加缓存失效：在 `src/main/java/com/tmd/controller/PStickController.java:70` 更新成功分支中删除 `PStick:{uid}`。
- 引入延时双删：为用户资料、附件、列表缓存等写路径在成功后调度二次删除（1–3s），可用线程池或消息队列驱动。
- 缓存删除失败重试：封装删除操作加入重试与降级队列（可用 RabbitMQ 死信队列），并在任务器中定期重试。
- 统一 TTL 兜底：为 `Stick:{uid}`、人物磁贴与部分统计键设置合理 TTL（5–15min），降低长期脏读与资源占用。

## 预热与退化策略
- Stale-While-Revalidate：列表页在主键未命中时优先返回 `:stale` 备份键数据，并并行重建主键，避免高并发下出现空列表和体验断崖。
- 实现位置：`src/main/java/com/tmd/service/impl/PostsServiceImpl.java:137` 读取主键；未命中后读取 `listKey:stale` 与 `totalKey:stale`；重建缓存仍受分布式锁保护，代理调用带重试（`src/main/java/com/tmd/service/impl/PostsServiceImpl.java:101`、`src/main/java/com/tmd/service/impl/PostsServiceImpl.java:223`）。
- 备份TTL：`LIST_STALE_TTL_SECONDS`、`TOTAL_STALE_TTL_SECONDS`，用于在缓存删除或过期窗口提供稳定退化。

## 重试机制说明
- 配置启用：已启用 `@EnableRetry`（`src/main/java/com/tmd/config/RetryConfig.java:21`），并提供 `RetryTemplate` Bean（指数退避/固定退避）。
- 代码位置：`@Retryable` 标注在 `PostsServiceImpl.cachePostsList`（`src/main/java/com/tmd/service/impl/PostsServiceImpl.java:101`），用于缓存恢复时的 Redis 写入重试。
- 调用方式：`getPosts` 在缓存未命中时，异步线程内调用 `cachePostsList`（`src/main/java/com/tmd/service/impl/PostsServiceImpl.java:218`）。
- AOP限制与影响：`cachePostsList` 为 `private` 且在同类内自调用，基于 Spring AOP 的 `@Retryable` 不会生效（与 `@Transactional` 同理，自调用绕过代理）。因此当前“重试机制”在该路径下实际上未触发。
- 推荐修复方案：
  - 抽取为单独的 `@Service`（例如 `PostsCacheService`）对外 `public` 方法标注 `@Retryable`，由 `PostsServiceImpl` 注入并调用，确保通过代理触发重试。
  - 或在当前异步恢复逻辑内显式使用 `RetryTemplate` 执行 Redis 写操作，避免 AOP 代理限制。
  - 不建议简单改为 `public` 后仍在同类自调用；需通过代理对象调用（例如拆分 Bean）。

## 规范建议
- Key 规范
  - 统一前缀、层级与分隔符：采用 `:` 分隔，业务维度从大到小；示例：`post:list:{type}:{status}:{sort}:{page}:{size}`。
  - 限制 Key 长度与内容，仅使用数字、字母、`:` 与下划线，避免动态文本直接入 Key。
- TTL 与失效
  - 列表类 TTL 推荐 60–300s；详情类 TTL 300–600s；集合型计数根据业务稳定性设置 5–30min；离线/会话类 24h/7d。
  - 更新型接口应同步删除相关列表/索引 Key，采用“双删 + 延迟删”仅在强一致需求下启用，优先使用集合精确维护（如 SADD/SREM）。
- 并发控制
  - 高并发恢复路径必配分布式锁 + 隔离键，锁等待 ≤10s；采用异步回填与“空响应”/“提示重试”策略避免阻塞。
- 防穿透与热点保护
  - 一致使用空值短 TTL 或布隆过滤器；对极热点 Key 允许本地热点降级（L1）与消息广播失效（启用组合缓存后）。
- 序列化与模型
  - 推荐统一 JSON 文本模型与版本化结构，显式转换；避免直接存放复杂对象（如含权限/连接）导致序列化不可控。

## 面试要点速记
- 列表/详情缓存策略、Key 设计与 TTL 取值逻辑，如何避免穿透/击穿/雪崩。
- 增量计数与阈值刷库的好处与一致性处理（DB + 缓存增量计算、ES 同步脚本更新）。
- 话题/邮件的空值缓存与 Redisson 锁的使用场景与参数选择。
- 私聊的会话 ZSet 模式、离线消息与 ACK TTL 保证、窗口清理策略。
- 二级缓存的设计（当前停用）：何时启用、跨节点失效的处理与 L1 开关策略。

## 代码索引（示例）
- Redis 初始化与序列化：`src/main/java/com/tmd/config/RedisConfig.java:12`
- 帖子列表缓存入口：`src/main/java/com/tmd/service/impl/PostsServiceImpl.java:121`
- 话题详情缓存：`src/main/java/com/tmd/service/impl/TopicServiceImpl.java:131`
- 邮件详情缓存：`src/main/java/com/tmd/service/impl/MailServiceImpl.java:72`
- 私聊会话与离线：`src/main/java/com/tmd/service/impl/PrivateChatServiceImpl.java:70`
- 登录态与刷新：`src/main/java/com/tmd/filter/JwtAuthenticationTokenFilter.java:64`
- 关注集合与计数：`src/main/java/com/tmd/service/impl/FollowServiceImpl.java:46`
- 附件多维缓存：`src/main/java/com/tmd/service/impl/AttachmentServiceImpl.java:191`
- 用户资料缓存：`src/main/java/com/tmd/service/impl/UserServiceimpl.java:85`
- 指标暂存：`src/main/java/com/tmd/metrics/impl/MetricsServiceImpl.java:30`
- 分布式 ID：`src/main/java/com/tmd/tools/RedisIdWorker.java:17`
