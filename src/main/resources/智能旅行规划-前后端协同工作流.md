# 智能旅行规划（含定制地图渲染）前后端协同工作流

## 概览
- 核心目标：围绕“用户需求 → 智能规划 → 地图定制渲染 → 增量更新”的完整闭环，清晰划分前后端职责与协作接口。
- 关键亮点：自定义地图样式与标点/路线渲染、TSP 路线优化与预算分配、增量更新与交互联动、异常兜底与限流。

## 前端流程
- 阶段 1：环境与组件初始化
  - 框架与网络：`Vue/React`、`Axios`；地图：高德/百度 JS API；样式：自定义主题 ID。
  - 初始化页面与地图容器；默认中心点与缩放（如成都、级别 10）；设置 UI 状态（未生成/加载中/成功/失败）。
- 阶段 2：需求采集与校验
  - 输入：目的地、天数、预算、偏好标签；可选语音输入转文本；攻略链接（仅格式校验）。
  - 校验：必填与范围（天数 1–15、预算≥0）、HTTP/HTTPS 链接；失败弹窗不发请求。
  - 标准化：生成结构化参数体（destination/days/budget/preferences/importLink/userType）。
- 阶段 3：请求封装与发送
  - 固定参数：`userId`（比赛固定值）、时间戳、坐标系（GCJ02）。
  - 发送：`POST /api/v1/travel/plan/generate`，`Content-Type: application/json`，附带简化 token。
  - 体验：展示“生成中”动画，禁用按钮；超时（10s）与断网提示。
- 阶段 4：响应接收与解析
  - 先判状态码（200/4xx/5xx）；成功则分解为“地图渲染数据”与“行程展示数据”。
  - 地图数据：景点经纬度/类型、每日路线坐标；展示数据：每日计划、预算、天气提示、交通耗时。
- 阶段 5：定制化地图渲染
  - 底图：加载自定义样式 ID；中心点定位与自适应缩放。
  - 标点：按类型定制图标（亲子/美食/历史），起点红、终点蓝；标点层级置顶。
  - 路线：`Day1/Day2/Day3` 多色折线（线宽 3px、平滑曲线），中点文字标签。
  - 联动：右侧时间轴与地图联动，高亮当前日标点与路线。
- 阶段 6：交互增强与二次操作
  - 标点弹卡：时长/门票/打卡点/预算；路线弹卡：步行/打车耗时与费用。
  - 二次修改：封装增量参数并调用 `POST /api/v1/travel/plan/update`；仅局部刷新地图与时间轴。

## 后端流程
- 阶段 1：服务初始化
  - 框架：`SpringBoot`（或 `FastAPI/Flask`）；配置数据库与第三方密钥（地图、天气），加载算法模块（TSP/NLP）。
  - 拆分（可标注不强制）：网关（鉴权/限流/日志）、智能规划服务、数据服务。
- 阶段 2：请求接收与网关前置
  - 鉴权：校验 token（比赛可固定）；限流：用户 1 分钟 ≤ 3 次；日志记录请求 ID/用户/时间/参数。
  - 参数校验：完整性与合法性（destination/days 等）；错误返回 400。
- 阶段 3：需求深度解析（NLP/规则）
  - 强化结构化：解析隐性需求（如“节奏慢/儿童友好/少步行/避高强度”）。
  - 标准化标签与避让标签，为后续筛选与排序提供特征。
- 阶段 4：多源数据拉取与清洗
  - 景点库：名称/经纬度/类型/评分/门票/时长/适配人群。
  - 地理：地理编码与路径规划（耗时/距离）；天气：未来 N 天天气。
  - 清洗：按标签过滤不匹配景点；补全缺失（默认时长等）；去重合并。
- 阶段 5：智能算法计算
  - 筛选与排序：计算匹配度，选 `N = days × 3` 个核心景点。
  - 路线优化：TSP 最短路与最少耗时；天气驱动替换室内/室外；每日 6–8h 分配时长与预算（餐饮/交通/门票）。
- 阶段 6：结果整合与响应
  - 输出 JSON：`requestId/status/data`，包含 `totalBudget/dailyPlans/weatherTips` 等核心字段。
  - 兜底：算法失败返回基础版行程；字段完整与默认值填充。
- 阶段 7：日志与监控（加分）
  - 记录算法耗时、数据拉取成功率；监控 QPS/失败率，支持演示性能优化思路。

## 前后端协作闭环（15 步）
- 1 启动：前端加载界面与地图容器；后端服务就绪。
- 2–4 输入与校验：前端结构化并发送至 `/generate`；后端网关鉴权限流与参数校验。
- 5–7 计算：后端解析需求、拉取与清洗数据、TSP 优化与预算分配。
- 8–11 返回与渲染：后端整合响应；前端解析数据，定制底图与标点/路线、时间轴联动。
- 12–14 交互与增量：前端弹卡交互与二次修改；后端 `/update` 增量计算；前端局部刷新。
- 15 导出闭环：展示最终行程，支持 PDF 导出（可选）。

## 接口契约
- 请求 `/api/v1/travel/plan/generate`
  - 头：`Authorization: Bearer <token>`，`Content-Type: application/json`
  - 体：`{ destination, days, budget, preferences[], importLink, userType, userId, ts, coord: "GCJ02" }`
- 响应（200）
  - `data.totalBudget:number`
  - `data.dailyPlans[ { day:number, scenicSpots:[{ name,lng,lat,type,visitTime,ticket,budget }], routePoints:[[lng,lat],...], dayBudget:number } ]`
  - `data.weatherTips:string`
- 增量 `/api/v1/travel/plan/update`
  - 体：仅变化参数（如 `{ deleteScenicSpot:"宽窄巷子", day:1 }`）
  - 响应：仅返回修改后的景点/路线，前端局部更新

## 数据示例
- 生成请求
  - `{ "destination":"成都", "days":3, "budget":2000, "preferences":["亲子","美食"], "importLink":"", "userType":"family", "userId":"test001", "ts":1734500000, "coord":"GCJ02" }`
- 生成响应（片段）
  - `{ "requestId":"req123456", "status":"success", "data":{ "totalBudget":1850, "dailyPlans":[{ "day":1, "scenicSpots":[{ "name":"成都大熊猫繁育研究基地", "lng":104.1095, "lat":30.7395, "type":"亲子", "visitTime":"9:00-11:00", "ticket":55, "budget":100 }], "routePoints":[[104.1095,30.7395],[104.0679,30.6638]], "dayBudget":600 }], "weatherTips":"Day2小雨，建议携带雨伞，已调整为室内行程" } }`

## 性能与鲁棒性
- 限流：网关 1 分钟 ≤ 3 次；前端按钮禁用与超时提示；后端可选令牌桶（Lua）。
- 缓存：按城市/标签缓存热门景点与路径耗时；TTL 加抖动避免雪崩；失败走基础版行程兜底。
- 增量计算：只重算受影响日与相邻路线，降低时延与开销。

## 安全与合规
- 鉴权：简化 token；参数与响应字段白名单；日志脱敏（用户标识）。
- 第三方：地图/天气 API 密钥安全存储（环境变量/配置中心）。

## 演示要点（比赛）
- 以“用户操作 → 前端响应 → 后端计算 → 地图定制 → 增量更新”叙述闭环。
- 强调亮点：自定义地图皮肤与多色路线、TSP + 天气调整、增量更新与局部刷新、异常兜底与限流。
